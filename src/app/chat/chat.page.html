<app-screen-header
  [title]="headerTitle || 'Chatbot'"
  [subtitle]="headerSubtitle"
  [emoji]="headerEmoji || ''"
  [accentColor]="headerColor"
  [showActionButton]="true"
  (back)="handleBack()"
  (action)="openOptions($event)"
></app-screen-header>

<ion-content [fullscreen]="false" class="bg-white">
  <!-- Settings panel removed from UI (configurada en TS) -->
  <div class="px-4 py-3 space-y-3">
    <div class="flex justify-center pt-1">
      <span class="rounded-full bg-brand-50 px-4 py-1 text-xs font-semibold text-brand-700">
      {{ chatStartedDisplay }}
      </span>
    </div>

    <div
      *ngFor="let msg of messages"
      class="flex"
      [class.justify-end]="msg.from === 'user'"
      [class.justify-start]="msg.from !== 'user'"
    >
      <div
        class="inline-block max-w-[85%] rounded-2xl px-4 py-2 ring-1"
        [class.bg-primary]="msg.from === 'user'"
        [class.text-white]="msg.from === 'user'"
        [class.ring-transparent]="msg.from === 'user'"
        [class.rounded-br-none]="msg.from === 'user'"
        [class.bg-white]="msg.from !== 'user'"
        [class.text-neutral-800]="msg.from !== 'user'"
        [class.ring-brand-100]="msg.from !== 'user'"
        [class.rounded-bl-none]="msg.from !== 'user'"
      >
        <div class="prose prose-sm max-w-none prose-headings:mt-2 prose-p:my-2 prose-pre:my-2 prose-code:before:content-[''] prose-code:after:content-['']" [innerHTML]="renderMarkdown(msg.text)"></div>
        <span class="block text-[11px] opacity-75 mt-1">{{ msg.time }}</span>
      </div>
    </div>
  </div>

</ion-content>

<ion-modal [isOpen]="isConfigOpen" (didDismiss)="closeConfiguration()" class="config-modal">
  <ng-template>
    <div class="max-h-[80vh] w-[min(520px,100vw)] overflow-y-auto bg-white p-6">
      <div class="mb-4 flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-neutral-900">Configuraci贸n del curso</h2>
          <p class="text-xs text-neutral-500" *ngIf="courseConfigName">Gestiona el chat de <strong>{{ courseConfigName }}</strong>.</p>
        </div>
        <button type="button" class="text-sm font-medium text-primary" (click)="closeConfiguration()">Cerrar</button>
      </div>

      <div *ngIf="configError" class="mb-4 rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-sm text-red-700">
        {{ configError }}
      </div>

      <div *ngIf="isConfigLoading && !configError" class="text-sm text-neutral-600">
        Cargando configuraci贸n del curso...
      </div>

      <div *ngIf="!isConfigLoading && !configError" class="space-y-8">
        <section>
          <div class="mb-3">
            <h3 class="text-sm font-semibold text-neutral-800">Prompt del curso</h3>
            <p class="text-xs text-neutral-500">
              Este mensaje se a帽ade antes de cada conversaci贸n. salo para definir objetivos, tono y reglas del asistente.
            </p>
          </div>
          <textarea
            class="h-36 w-full rounded-xl border border-neutral-200 bg-neutral-50 p-3 text-sm focus:border-brand-200 focus:outline-none focus:ring-1 focus:ring-brand-300"
            [(ngModel)]="promptDraft"
            placeholder="Ej: Responde como profesor/a del curso, priorizando los contenidos del temario oficial..."
          ></textarea>
          <div class="mt-3 flex flex-wrap items-center gap-3">
            <ion-button size="small" (click)="savePrompt()" [disabled]="isSavingPrompt">
              <ion-icon slot="start" name="save-outline"></ion-icon>
              Guardar prompt
            </ion-button>
            <span *ngIf="isSavingPrompt" class="text-xs text-neutral-500">Guardando...</span>
            <span *ngIf="promptSaveMessage && !isSavingPrompt" class="text-xs text-green-600">{{ promptSaveMessage }}</span>
          </div>
        </section>

        <section>
          <div class="mb-3 flex flex-wrap items-center justify-between gap-3">
            <div>
              <h3 class="text-sm font-semibold text-neutral-800">Archivos del curso</h3>
              <p class="text-xs text-neutral-500">
                Los archivos parseados se a帽aden autom谩ticamente al contexto del chatbot.
              </p>
            </div>
            <div class="flex items-center gap-2">
              <input
                type="file"
                #configFileInput
                class="hidden"
                (change)="onConfigFileSelected($event)"
                [disabled]="isUploadingFile"
              />
              <ion-button size="small" fill="outline" (click)="configFileInput.click()" [disabled]="isUploadingFile">
                <ion-icon slot="start" name="cloud-upload"></ion-icon>
                {{ isUploadingFile ? 'Subiendo...' : 'Agregar archivo' }}
              </ion-button>
            </div>
          </div>

          <div *ngIf="uploadError" class="mb-3 rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-700">
            {{ uploadError }}
          </div>
          <div *ngIf="filesMessage" class="mb-3 rounded-xl border border-green-100 bg-green-50 px-3 py-2 text-xs text-green-700">
            {{ filesMessage }}
          </div>

          <div *ngIf="isFilesLoading" class="text-xs text-neutral-500">
            Actualizando lista de archivos...
          </div>

          <ng-container *ngIf="!isFilesLoading">
            <div *ngIf="files.length === 0" class="rounded-xl border border-dashed border-neutral-200 bg-neutral-50 px-4 py-6 text-center text-xs text-neutral-500">
              A煤n no hay archivos cargados para este curso.
            </div>

            <div *ngIf="files.length" class="space-y-2">
              <div
                *ngFor="let file of files"
                class="flex flex-wrap items-center justify-between gap-3 rounded-xl border border-neutral-200 bg-white px-4 py-3 text-sm"
              >
                <div class="min-w-0 flex-1">
                  <p class="truncate font-medium text-neutral-800">{{ file.filename }}</p>
                  <p class="text-xs text-neutral-500">
                    Subido {{ file.uploaded_at ? (file.uploaded_at | date: 'short') : 'sin fecha' }}
                    路 Tama帽o {{ file.filesize | number }} bytes
                    <span *ngIf="file.has_parsed_content"> 路 Parseado</span>
                  </p>
                </div>
                <ion-button
                  size="small"
                  fill="clear"
                  color="danger"
                  (click)="deleteFile(file.id)"
                  [disabled]="isDeletingFileId === file.id"
                >
                  <ion-icon slot="start" name="trash-outline"></ion-icon>
                  {{ isDeletingFileId === file.id ? 'Eliminando...' : 'Eliminar' }}
                </ion-button>
              </div>
            </div>
          </ng-container>
        </section>
      </div>
    </div>
  </ng-template>
</ion-modal>

<app-action-menu
  [isOpen]="isOptionsOpen"
  [event]="optionsEvent"
  [actions]="menuActions"
  (dismiss)="closeOptions()"
  (actionSelected)="handleMenuSelection($event)"
></app-action-menu>
<ion-footer class="bg-white no-shadow" [style.box-shadow]="'none'" [style.border-top]="'0'" [style.--border-color]="'transparent'" [style.filter]="'none'">
  <div class="px-4 pt-3 pb-[calc(var(--ion-safe-area-bottom,env(safe-area-inset-bottom))+14px)]">
    <div class="mx-auto flex max-w-sm items-center gap-3">
      <!-- Clear button (black) -->
      <ion-button
        fill="solid"
        (click)="clearChat()"
        [style.--border-radius]="'9999px'"
        [style.--padding-start]="'0'"
        [style.--padding-end]="'0'"
        [style.--padding-top]="'0'"
        [style.--padding-bottom]="'0'"
        [style.--background]="'var(--color-brand-900)'"
        [style.width]="'44px'"
        [style.height]="'44px'"
      >
        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
      </ion-button>

      <!-- Input pill -->
      <div class="flex h-[44px] flex-1 items-center rounded-full bg-neutral-300 px-4 transition-colors border border-transparent focus-within:border-[color:var(--color-brand-100)]">
        <ion-input
          [(ngModel)]="draft"
          [clearInput]="true"
          placeholder="Escribe un mensaje..."
          class="w-full bg-transparent"
          [style.--highlight-color-focused]="'transparent'"
          [style.--highlight-color]="'transparent'"
          [style.--border-color]="'transparent'"
          enterkeyhint="send"
          (keyup.enter)="sendMessage()"
        ></ion-input>
      </div>

      <!-- Send circular -->
      <ion-button
        (click)="sendMessage()"
        [disabled]="!(draft && draft.trim()) || isSending"
        [style.--border-radius]="'9999px'"
        [style.--padding-start]="'0'"
        [style.--padding-end]="'0'"
        [style.--padding-top]="'0'"
        [style.--padding-bottom]="'0'"
        [style.--background]="'var(--color-primary)'"
        [style.width]="'44px'"
        [style.height]="'44px'"
      >
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </div>

</ion-footer>
